
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>macauff.counterpart_pairing &#8212; macauff</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">macauff</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">macauff.counterpart_pairing</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for macauff.counterpart_pairing</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This module provides the functionality for the final cross-match process, the</span>
<span class="sd">act of actually pairing sources across the two catalogues as counterparts.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">.misc_functions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">create_auf_params_grid</span><span class="p">,</span> <span class="n">load_small_ref_auf_grid</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.misc_functions_fortran</span> <span class="kn">import</span> <span class="n">misc_functions_fortran</span> <span class="k">as</span> <span class="n">mff</span>
<span class="kn">from</span> <span class="nn">.counterpart_pairing_fortran</span> <span class="kn">import</span> <span class="n">counterpart_pairing_fortran</span> <span class="k">as</span> <span class="n">cpf</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;source_pairing&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="source_pairing"><a class="viewcode-back" href="../../api/macauff.source_pairing.html#macauff.source_pairing">[docs]</a><span class="k">def</span> <span class="nf">source_pairing</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="n">b_cat_folder_path</span><span class="p">,</span> <span class="n">a_auf_folder_path</span><span class="p">,</span>
                   <span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="n">a_filt_names</span><span class="p">,</span> <span class="n">b_filt_names</span><span class="p">,</span> <span class="n">a_auf_pointings</span><span class="p">,</span> <span class="n">b_auf_pointings</span><span class="p">,</span>
                   <span class="n">rho</span><span class="p">,</span> <span class="n">drho</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">,</span> <span class="n">mem_chunk_num</span><span class="p">,</span> <span class="n">n_pool</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to iterate over all grouped islands of sources, calculating the</span>
<span class="sd">    probabilities of all permutations of matches and deriving the most likely</span>
<span class="sd">    counterparts for sources in the two catalogues.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    joint_folder_path : string</span>
<span class="sd">        Folder in which all common match files are stored for this crossmatch.</span>
<span class="sd">    a_cat_folder_path : string</span>
<span class="sd">        Folder in which the &quot;a&quot; catalogue input catalogues are stored.</span>
<span class="sd">    b_cat_folder_path : string</span>
<span class="sd">        Folder where catalogue &quot;b&quot; files are located.</span>
<span class="sd">    a_auf_folder_path : string</span>
<span class="sd">        Folder where catalogue &quot;a&quot; perturbation AUF component files were saved</span>
<span class="sd">        previously.</span>
<span class="sd">    b_auf_folder_path : string</span>
<span class="sd">        Folder containing catalogue &quot;b&quot; perturbation AUF component files.</span>
<span class="sd">    a_filt_names : numpy.ndarray or list of strings</span>
<span class="sd">        Array or list containing names of the filters used in catalogue &quot;a&quot;.</span>
<span class="sd">    b_filt_names : numpy.ndarray or list of strings</span>
<span class="sd">        Array or list of catalogue &quot;b&quot; filter names.</span>
<span class="sd">    a_auf_pointings : numpy.ndarray</span>
<span class="sd">        Array of celestial coordinates indicating the locations used in the</span>
<span class="sd">        simulations of perturbation AUFs for catalogue &quot;a&quot;.</span>
<span class="sd">    b_auf_pointings : numpy.ndarray</span>
<span class="sd">        Sky coordinates of locations of catalogue &quot;b&quot; perturbation AUF</span>
<span class="sd">        component simulations.</span>
<span class="sd">    rho : numpy.ndarray</span>
<span class="sd">        Array of fourier-space values, used in the convolution of PDFs.</span>
<span class="sd">    drho : numpy.ndarray</span>
<span class="sd">        The spacings between the `rho` array elements.</span>
<span class="sd">    n_fracs : integer</span>
<span class="sd">        The number of relative contamination fluxes previously considered</span>
<span class="sd">        when calculating the probability of a source being contaminated by</span>
<span class="sd">        a perturbing source brighter than a given flux.</span>
<span class="sd">    mem_chunk_num : integer</span>
<span class="sd">        Number of sub-arrays to break loading of main catalogue into, to</span>
<span class="sd">        reduce the amount of memory used.</span>
<span class="sd">    n_pool : integer</span>
<span class="sd">        The number of `multiprocessing` parallel processes to break island</span>
<span class="sd">        matches down into.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating catalogue matches...&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c1"># Create the estimated levels of flux contamination and fraction of</span>
    <span class="c1"># contaminated source grids.</span>
    <span class="n">create_auf_params_grid</span><span class="p">(</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="n">a_auf_pointings</span><span class="p">,</span> <span class="n">a_filt_names</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">)</span>
    <span class="n">create_auf_params_grid</span><span class="p">(</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="n">a_auf_pointings</span><span class="p">,</span> <span class="n">a_filt_names</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">)</span>
    <span class="n">create_auf_params_grid</span><span class="p">(</span><span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="n">b_auf_pointings</span><span class="p">,</span> <span class="n">b_filt_names</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">)</span>
    <span class="n">create_auf_params_grid</span><span class="p">(</span><span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="n">b_auf_pointings</span><span class="p">,</span> <span class="n">b_filt_names</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pairing sources...&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">len_a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_astro.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_cat_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
    <span class="n">len_b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_astro.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_cat_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
    <span class="n">small_len</span><span class="p">,</span> <span class="n">large_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">len_a</span><span class="p">,</span> <span class="n">len_b</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">len_a</span><span class="p">,</span> <span class="n">len_b</span><span class="p">)</span>

    <span class="n">acountinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/ac.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,))</span>
    <span class="n">bcountinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bc.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,))</span>
    <span class="n">acontamprob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/pacontam.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">))</span>
    <span class="n">bcontamprob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/pbcontam.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">))</span>
    <span class="n">acontamflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/acontamflux.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,))</span>
    <span class="n">bcontamflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bcontamflux.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,))</span>
    <span class="n">probcarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/pc.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,))</span>
    <span class="n">etaarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/eta.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                         <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,))</span>
    <span class="n">xiarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/xi.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">cnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem_chunk_num</span><span class="p">):</span>
        <span class="n">lowind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">small_len</span><span class="o">*</span><span class="n">cnum</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">highind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">small_len</span><span class="o">*</span><span class="p">(</span><span class="n">cnum</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">acountinds</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="n">large_len</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">bcountinds</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="n">large_len</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">acontamprob</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="n">bcontamprob</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="n">acontamflux</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="n">bcontamflux</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="n">probcarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="n">etaarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
        <span class="n">xiarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
    <span class="n">afieldinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/af.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">len_a</span><span class="p">,))</span>
    <span class="n">probfaarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/pfa.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">len_a</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">cnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem_chunk_num</span><span class="p">):</span>
        <span class="n">lowind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">len_a</span><span class="o">*</span><span class="n">cnum</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">highind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">len_a</span><span class="o">*</span><span class="p">(</span><span class="n">cnum</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">afieldinds</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="n">large_len</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">probfaarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
    <span class="n">bfieldinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bf.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">len_b</span><span class="p">,))</span>
    <span class="n">probfbarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/pfb.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">len_b</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">cnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem_chunk_num</span><span class="p">):</span>
        <span class="n">lowind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">len_b</span><span class="o">*</span><span class="n">cnum</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">highind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">len_b</span><span class="o">*</span><span class="p">(</span><span class="n">cnum</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">bfieldinds</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="n">large_len</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">probfbarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>

    <span class="n">counterpartticker</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">afieldticker</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bfieldticker</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">isle_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/group/alist.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">abinsarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/abinsarray.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">abinlengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/abinlengths.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">bbinsarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/bbinsarray.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">bbinlengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/bbinlengths.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="n">c_priors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/c_priors.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">c_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/c_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">fa_priors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/fa_priors.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">fa_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/fa_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">fb_priors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/fb_priors.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">fb_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/fb_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem_chunk_num</span><span class="p">):</span>
        <span class="n">lowind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">isle_len</span><span class="o">*</span><span class="n">cnum</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">highind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">isle_len</span><span class="o">*</span><span class="p">(</span><span class="n">cnum</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">alist_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/group/alist.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                         <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[:,</span> <span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span>
        <span class="n">agrplen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/group/agrplen.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                          <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span>
        <span class="n">alist_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">alist_</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">agrplen</span><span class="p">),</span> <span class="p">:])</span>
        <span class="n">alistunique_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">alist_</span><span class="p">[</span><span class="n">alist_</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">a_astro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_astro.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_cat_folder_path</span><span class="p">),</span>
                          <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">alistunique_flat</span><span class="p">]</span>
        <span class="n">a_photo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_photo.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_cat_folder_path</span><span class="p">),</span>
                          <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">alistunique_flat</span><span class="p">]</span>
        <span class="n">amagref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/magref.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_cat_folder_path</span><span class="p">),</span>
                          <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">alistunique_flat</span><span class="p">]</span>
        <span class="n">maparray</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">maparray</span><span class="p">[</span><span class="n">alistunique_flat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a_astro</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># *list maps the subarray indices, but *list_ keeps the full catalogue indices</span>
        <span class="n">alist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">maparray</span><span class="p">[</span><span class="n">alist_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">alist_</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">a_sky_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/a_sky_inds.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                             <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">alistunique_flat</span><span class="p">]</span>

        <span class="n">blist_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/group/blist.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                         <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[:,</span> <span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span>
        <span class="n">bgrplen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/group/bgrplen.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                          <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span>
        <span class="n">blist_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">blist_</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">bgrplen</span><span class="p">),</span> <span class="p">:])</span>
        <span class="n">blistunique_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">blist_</span><span class="p">[</span><span class="n">blist_</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">b_astro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_astro.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_cat_folder_path</span><span class="p">),</span>
                          <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">blistunique_flat</span><span class="p">]</span>
        <span class="n">b_photo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_photo.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_cat_folder_path</span><span class="p">),</span>
                          <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">blistunique_flat</span><span class="p">]</span>
        <span class="n">bmagref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/magref.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_cat_folder_path</span><span class="p">),</span>
                          <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">blistunique_flat</span><span class="p">]</span>
        <span class="n">maparray</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_b</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">maparray</span><span class="p">[</span><span class="n">blistunique_flat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_astro</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">blist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">maparray</span><span class="p">[</span><span class="n">blist_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">blist_</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">b_sky_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/phot_like/b_sky_inds.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                             <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">blistunique_flat</span><span class="p">]</span>

        <span class="n">amodrefind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/modelrefinds.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a_auf_folder_path</span><span class="p">),</span>
                             <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[:,</span> <span class="n">alistunique_flat</span><span class="p">]</span>
        <span class="p">[</span><span class="n">afourier_grids</span><span class="p">,</span> <span class="n">afrac_grids</span><span class="p">,</span> <span class="n">aflux_grids</span><span class="p">],</span> <span class="n">amodrefind</span> <span class="o">=</span> <span class="n">load_small_ref_auf_grid</span><span class="p">(</span>
            <span class="n">amodrefind</span><span class="p">,</span> <span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;fourier&#39;</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">])</span>

        <span class="n">bmodrefind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/modelrefinds.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b_auf_folder_path</span><span class="p">),</span>
                             <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)[:,</span> <span class="n">blistunique_flat</span><span class="p">]</span>
        <span class="p">[</span><span class="n">bfourier_grids</span><span class="p">,</span> <span class="n">bfrac_grids</span><span class="p">,</span> <span class="n">bflux_grids</span><span class="p">],</span> <span class="n">bmodrefind</span> <span class="o">=</span> <span class="n">load_small_ref_auf_grid</span><span class="p">(</span>
            <span class="n">bmodrefind</span><span class="p">,</span> <span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;fourier&#39;</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">,</span> <span class="s1">&#39;flux&#39;</span><span class="p">])</span>

        <span class="c1"># Initialise the multiprocessing loop setup:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">n_pool</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">alist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">expand_constants</span> <span class="o">=</span> <span class="p">[</span><span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">a_astro</span><span class="p">,</span> <span class="n">a_photo</span><span class="p">,</span> <span class="n">b_astro</span><span class="p">,</span> <span class="n">b_photo</span><span class="p">,</span> <span class="n">alist</span><span class="p">,</span> <span class="n">alist_</span><span class="p">,</span> <span class="n">blist</span><span class="p">,</span> <span class="n">blist_</span><span class="p">,</span> <span class="n">agrplen</span><span class="p">,</span> <span class="n">bgrplen</span><span class="p">,</span>
            <span class="n">c_array</span><span class="p">,</span> <span class="n">fa_array</span><span class="p">,</span> <span class="n">fb_array</span><span class="p">,</span> <span class="n">c_priors</span><span class="p">,</span> <span class="n">fa_priors</span><span class="p">,</span> <span class="n">fb_priors</span><span class="p">,</span> <span class="n">amagref</span><span class="p">,</span> <span class="n">bmagref</span><span class="p">,</span>
            <span class="n">amodrefind</span><span class="p">,</span> <span class="n">bmodrefind</span><span class="p">,</span> <span class="n">abinsarray</span><span class="p">,</span> <span class="n">abinlengths</span><span class="p">,</span> <span class="n">bbinsarray</span><span class="p">,</span> <span class="n">bbinlengths</span><span class="p">,</span>
            <span class="n">afrac_grids</span><span class="p">,</span> <span class="n">aflux_grids</span><span class="p">,</span> <span class="n">bfrac_grids</span><span class="p">,</span> <span class="n">bflux_grids</span><span class="p">,</span> <span class="n">afourier_grids</span><span class="p">,</span> <span class="n">bfourier_grids</span><span class="p">,</span>
            <span class="n">a_sky_inds</span><span class="p">,</span> <span class="n">b_sky_inds</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">drho</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">]]</span>
        <span class="n">iter_group</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="o">*</span><span class="n">expand_constants</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">return_items</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">_individual_island_probability</span><span class="p">,</span> <span class="n">iter_group</span><span class="p">,</span>
                                                <span class="n">chunksize</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_pool</span><span class="p">)):</span>
            <span class="c1"># Use the quick-return check in _individual_island_probability</span>
            <span class="c1"># as a short-hand for zero-length island -- i.e., sources in one</span>
            <span class="c1"># catalogue only -- and update the probabilities of the field</span>
            <span class="c1"># sources accordingly:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">q</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">return_items</span><span class="p">]):</span>
                <span class="c1"># If &#39;a&#39; in the returned array, assume no &quot;b&quot; sources (all &quot;a&quot;</span>
                <span class="c1"># objects), and update afield; otherwise &#39;b&#39; indicates an empty</span>
                <span class="c1"># &quot;a&quot; island, and lonely &quot;b&quot; sources.</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">q</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">return_items</span><span class="p">]):</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">aperm</span><span class="p">,</span> <span class="n">aperm_</span> <span class="o">=</span> <span class="n">return_items</span>
                    <span class="n">afieldinds</span><span class="p">[</span><span class="n">afieldticker</span><span class="p">:</span><span class="n">afieldticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">)]</span> <span class="o">=</span> <span class="n">aperm_</span>
                    <span class="n">probfaarray</span><span class="p">[</span><span class="n">afieldticker</span><span class="p">:</span><span class="n">afieldticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">afieldticker</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bperm</span><span class="p">,</span> <span class="n">bperm_</span> <span class="o">=</span> <span class="n">return_items</span>
                    <span class="n">bfieldinds</span><span class="p">[</span><span class="n">bfieldticker</span><span class="p">:</span><span class="n">bfieldticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bperm_</span>
                    <span class="n">probfbarray</span><span class="p">[</span><span class="n">bfieldticker</span><span class="p">:</span><span class="n">bfieldticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">bfieldticker</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">[</span><span class="n">acrpts</span><span class="p">,</span> <span class="n">bcrpts</span><span class="p">,</span> <span class="n">acrptscontp</span><span class="p">,</span> <span class="n">bcrptscontp</span><span class="p">,</span> <span class="n">etacrpts</span><span class="p">,</span> <span class="n">xicrpts</span><span class="p">,</span> <span class="n">acrptflux</span><span class="p">,</span> <span class="n">bcrptflux</span><span class="p">,</span>
                 <span class="n">afield</span><span class="p">,</span> <span class="n">bfield</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">integral</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_items</span>
                <span class="n">acountinds</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">acrpts</span><span class="p">)]</span> <span class="o">=</span> <span class="n">acrpts</span>
                <span class="n">bcountinds</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bcrpts</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bcrpts</span>
                <span class="n">acontamprob</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">acrptscontp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">acrptscontp</span>
                <span class="n">bcontamprob</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bcrptscontp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bcrptscontp</span>
                <span class="n">etaarray</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bcrptscontp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">etacrpts</span>
                <span class="n">xiarray</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bcrptscontp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">xicrpts</span>
                <span class="n">acontamflux</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">acrptflux</span><span class="p">)]</span> <span class="o">=</span> <span class="n">acrptflux</span>
                <span class="n">bcontamflux</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bcrptflux</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bcrptflux</span>
                <span class="n">probcarray</span><span class="p">[</span><span class="n">counterpartticker</span><span class="p">:</span><span class="n">counterpartticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">acrpts</span><span class="p">)]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">/</span><span class="n">integral</span>
                <span class="n">counterpartticker</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acrpts</span><span class="p">)</span>

                <span class="n">afieldinds</span><span class="p">[</span><span class="n">afieldticker</span><span class="p">:</span><span class="n">afieldticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">afield</span><span class="p">)]</span> <span class="o">=</span> <span class="n">afield</span>
                <span class="n">probfaarray</span><span class="p">[</span><span class="n">afieldticker</span><span class="p">:</span><span class="n">afieldticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">afield</span><span class="p">)]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">/</span><span class="n">integral</span>
                <span class="n">afieldticker</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">afield</span><span class="p">)</span>

                <span class="n">bfieldinds</span><span class="p">[</span><span class="n">bfieldticker</span><span class="p">:</span><span class="n">bfieldticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bfield</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bfield</span>
                <span class="n">probfbarray</span><span class="p">[</span><span class="n">bfieldticker</span><span class="p">:</span><span class="n">bfieldticker</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">bfield</span><span class="p">)]</span> <span class="o">=</span> <span class="n">prob</span><span class="o">/</span><span class="n">integral</span>
                <span class="n">bfieldticker</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bfield</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">countfilter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/countfilt.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">small_len</span><span class="p">,))</span>
    <span class="n">afieldfilter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/afieldfilt.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                             <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">len_a</span><span class="p">,))</span>
    <span class="n">bfieldfilter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bfieldfilt.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                             <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">len_b</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">cnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem_chunk_num</span><span class="p">):</span>
        <span class="n">lowind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">small_len</span><span class="o">*</span><span class="n">cnum</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">highind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">small_len</span><span class="o">*</span><span class="p">(</span><span class="n">cnum</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># *contamprob is (smalllen, nfracs) in shape and our check for correctness needs to check</span>
        <span class="c1"># all nfrac values, requiring an all check.</span>
        <span class="n">countfilter</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">acountinds</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">large_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">bcountinds</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">large_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acontamprob</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">bcontamprob</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">acontamflux</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">bcontamflux</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">probcarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">etaarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">xiarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">10</span><span class="p">))</span>

        <span class="n">lowind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">len_a</span><span class="o">*</span><span class="n">cnum</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">highind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">len_a</span><span class="o">*</span><span class="p">(</span><span class="n">cnum</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">afieldfilter</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">afieldinds</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">large_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">probfaarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">lowind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">len_b</span><span class="o">*</span><span class="n">cnum</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">highind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">len_b</span><span class="o">*</span><span class="p">(</span><span class="n">cnum</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mem_chunk_num</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">bfieldfilter</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">bfieldinds</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">large_len</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
                                        <span class="p">(</span><span class="n">probfbarray</span><span class="p">[</span><span class="n">lowind</span><span class="p">:</span><span class="n">highind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/reject/reject_a.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">)):</span>
        <span class="n">lenrejecta</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/reject/reject_a.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                 <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lenrejecta</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/reject/reject_b.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">)):</span>
        <span class="n">lenrejectb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/reject/reject_b.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">),</span>
                                 <span class="n">mmap_mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lenrejectb</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">countsum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">countfilter</span><span class="p">))</span>
    <span class="n">afieldsum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">afieldfilter</span><span class="p">))</span>
    <span class="n">bfieldsum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bfieldfilter</span><span class="p">))</span>

    <span class="c1"># Reduce size of output files, removing anything that doesn&#39;t meet the</span>
    <span class="c1"># criteria above from all saved numpy arrays.</span>
    <span class="k">for</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">typing</span><span class="p">,</span> <span class="n">filter_variable</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">,</span> <span class="s1">&#39;bc&#39;</span><span class="p">,</span> <span class="s1">&#39;pacontam&#39;</span><span class="p">,</span> <span class="s1">&#39;pbcontam&#39;</span><span class="p">,</span> <span class="s1">&#39;acontamflux&#39;</span><span class="p">,</span> <span class="s1">&#39;bcontamflux&#39;</span><span class="p">,</span> <span class="s1">&#39;af&#39;</span><span class="p">,</span> <span class="s1">&#39;bf&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">,</span>
         <span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="s1">&#39;pfa&#39;</span><span class="p">,</span> <span class="s1">&#39;pfb&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="n">acountinds</span><span class="p">,</span> <span class="n">bcountinds</span><span class="p">,</span> <span class="n">acontamprob</span><span class="p">,</span> <span class="n">bcontamprob</span><span class="p">,</span> <span class="n">acontamflux</span><span class="p">,</span> <span class="n">bcontamflux</span><span class="p">,</span> <span class="n">afieldinds</span><span class="p">,</span>
         <span class="n">bfieldinds</span><span class="p">,</span> <span class="n">probcarray</span><span class="p">,</span> <span class="n">etaarray</span><span class="p">,</span> <span class="n">xiarray</span><span class="p">,</span> <span class="n">probfaarray</span><span class="p">,</span> <span class="n">probfbarray</span><span class="p">],</span>
        <span class="p">[(</span><span class="n">countsum</span><span class="p">,),</span> <span class="p">(</span><span class="n">countsum</span><span class="p">,),</span> <span class="p">(</span><span class="n">countsum</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">),</span> <span class="p">(</span><span class="n">countsum</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">),</span> <span class="p">(</span><span class="n">countsum</span><span class="p">,),</span>
         <span class="p">(</span><span class="n">countsum</span><span class="p">,),</span> <span class="p">(</span><span class="n">afieldsum</span><span class="p">,),</span> <span class="p">(</span><span class="n">bfieldsum</span><span class="p">,),</span> <span class="p">(</span><span class="n">countsum</span><span class="p">,),</span> <span class="p">(</span><span class="n">countsum</span><span class="p">,),</span> <span class="p">(</span><span class="n">countsum</span><span class="p">,),</span>
         <span class="p">(</span><span class="n">afieldsum</span><span class="p">,),</span> <span class="p">(</span><span class="n">bfieldsum</span><span class="p">,)],</span>
        <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="p">[</span><span class="n">countfilter</span><span class="p">,</span> <span class="n">countfilter</span><span class="p">,</span> <span class="n">countfilter</span><span class="p">,</span> <span class="n">countfilter</span><span class="p">,</span> <span class="n">countfilter</span><span class="p">,</span> <span class="n">countfilter</span><span class="p">,</span>
         <span class="n">afieldfilter</span><span class="p">,</span> <span class="n">bfieldfilter</span><span class="p">,</span> <span class="n">countfilter</span><span class="p">,</span> <span class="n">countfilter</span><span class="p">,</span> <span class="n">countfilter</span><span class="p">,</span> <span class="n">afieldfilter</span><span class="p">,</span>
         <span class="n">bfieldfilter</span><span class="p">]):</span>
        <span class="n">temp_variable</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">2.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">typing</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">di</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">20</span><span class="p">)</span>
        <span class="n">temp_c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">di</span><span class="p">):</span>
            <span class="n">n_extra</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filter_variable</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="p">]))</span>
            <span class="n">temp_variable</span><span class="p">[</span><span class="n">temp_c</span><span class="p">:</span><span class="n">temp_c</span><span class="o">+</span><span class="n">n_extra</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="p">][</span><span class="n">filter_variable</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">di</span><span class="p">]]</span>
            <span class="n">temp_c</span> <span class="o">+=</span> <span class="n">n_extra</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">2.npy </span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span>
                  <span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">acountinds</span><span class="p">,</span> <span class="n">bcountinds</span><span class="p">,</span> <span class="n">acontamprob</span><span class="p">,</span> <span class="n">bcontamprob</span><span class="p">,</span> <span class="n">acontamflux</span><span class="p">,</span> <span class="n">bcontamflux</span><span class="p">,</span> <span class="n">afieldinds</span>
    <span class="k">del</span> <span class="n">bfieldinds</span><span class="p">,</span> <span class="n">probcarray</span><span class="p">,</span> <span class="n">etaarray</span><span class="p">,</span> <span class="n">xiarray</span><span class="p">,</span> <span class="n">probfaarray</span><span class="p">,</span> <span class="n">probfbarray</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="n">countsum</span> <span class="o">+</span> <span class="n">afieldsum</span> <span class="o">+</span> <span class="n">lenrejecta</span>
    <span class="k">if</span> <span class="n">tot</span> <span class="o">&lt;</span> <span class="n">len_a</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> catalogue a source</span><span class="si">{}</span><span class="s2"> not in either counterpart, field, or rejected &quot;</span>
                      <span class="s2">&quot;source lists.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">len_a</span> <span class="o">-</span> <span class="n">tot</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="n">len_a</span> <span class="o">-</span> <span class="n">tot</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tot</span> <span class="o">&gt;</span> <span class="n">len_a</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> additional catalogue a </span><span class="si">{}</span><span class="s2"> recorded, check results for duplications &quot;</span>
                      <span class="s2">&quot;carefully&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tot</span> <span class="o">-</span> <span class="n">len_a</span><span class="p">,</span> <span class="s1">&#39;indices&#39;</span> <span class="k">if</span> <span class="n">tot</span> <span class="o">-</span> <span class="n">len_a</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;index&#39;</span><span class="p">))</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="n">countsum</span> <span class="o">+</span> <span class="n">bfieldsum</span> <span class="o">+</span> <span class="n">lenrejectb</span>
    <span class="k">if</span> <span class="n">tot</span> <span class="o">&lt;</span> <span class="n">len_b</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> catalogue b source</span><span class="si">{}</span><span class="s2"> not in either counterpart, field, or rejected &quot;</span>
                      <span class="s2">&quot;source lists.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">len_b</span> <span class="o">-</span> <span class="n">tot</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="n">len_b</span> <span class="o">-</span> <span class="n">tot</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tot</span> <span class="o">&gt;</span> <span class="n">len_b</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> additional catalogue b </span><span class="si">{}</span><span class="s2"> recorded, check results for duplications &quot;</span>
                      <span class="s2">&quot;carefully&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tot</span> <span class="o">-</span> <span class="n">len_b</span><span class="p">,</span> <span class="s1">&#39;indices&#39;</span> <span class="k">if</span> <span class="n">tot</span> <span class="o">-</span> <span class="n">len_b</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;index&#39;</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">del</span> <span class="n">countfilter</span><span class="p">,</span> <span class="n">afieldfilter</span><span class="p">,</span> <span class="n">bfieldfilter</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/countfilt.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/afieldfilt.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bfieldfilt.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joint_folder_path</span><span class="p">))</span>

    <span class="k">return</span></div>


<span class="k">def</span> <span class="nf">_individual_island_probability</span><span class="p">(</span><span class="n">iterable_wrapper</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Individual island probability derivations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iterable_wrapper : list</span>
<span class="sd">        List of parameters used within `_individual_island_probability` to</span>
<span class="sd">        calculate the probability of (non-)match and assorted secondary</span>
<span class="sd">        match parameters.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">a_astro</span><span class="p">,</span> <span class="n">a_photo</span><span class="p">,</span> <span class="n">b_astro</span><span class="p">,</span> <span class="n">b_photo</span><span class="p">,</span> <span class="n">alist</span><span class="p">,</span> <span class="n">alist_</span><span class="p">,</span> <span class="n">blist</span><span class="p">,</span> <span class="n">blist_</span><span class="p">,</span> <span class="n">agrplen</span><span class="p">,</span> <span class="n">bgrplen</span><span class="p">,</span>
     <span class="n">c_array</span><span class="p">,</span> <span class="n">fa_array</span><span class="p">,</span> <span class="n">fb_array</span><span class="p">,</span> <span class="n">c_priors</span><span class="p">,</span> <span class="n">fa_priors</span><span class="p">,</span> <span class="n">fb_priors</span><span class="p">,</span> <span class="n">amagref</span><span class="p">,</span> <span class="n">bmagref</span><span class="p">,</span> <span class="n">amodelrefinds</span><span class="p">,</span>
     <span class="n">bmodelrefinds</span><span class="p">,</span> <span class="n">abinsarray</span><span class="p">,</span> <span class="n">abinlengths</span><span class="p">,</span> <span class="n">bbinsarray</span><span class="p">,</span> <span class="n">bbinlengths</span><span class="p">,</span> <span class="n">afrac_grids</span><span class="p">,</span> <span class="n">aflux_grids</span><span class="p">,</span>
     <span class="n">bfrac_grids</span><span class="p">,</span> <span class="n">bflux_grids</span><span class="p">,</span> <span class="n">afourier_grids</span><span class="p">,</span> <span class="n">bfourier_grids</span><span class="p">,</span> <span class="n">a_sky_inds</span><span class="p">,</span> <span class="n">b_sky_inds</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">drho</span><span class="p">,</span>
     <span class="n">n_fracs</span><span class="p">]</span> <span class="o">=</span> <span class="n">iterable_wrapper</span>

    <span class="k">if</span> <span class="n">bgrplen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alist</span><span class="p">[:</span><span class="n">agrplen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="n">alist_</span><span class="p">[:</span><span class="n">agrplen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">agrplen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">blist</span><span class="p">[:</span><span class="n">bgrplen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="n">blist_</span><span class="p">[:</span><span class="n">bgrplen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aperm</span> <span class="o">=</span> <span class="n">alist</span><span class="p">[:</span><span class="n">agrplen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">bperm</span> <span class="o">=</span> <span class="n">blist</span><span class="p">[:</span><span class="n">bgrplen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">aperm_</span> <span class="o">=</span> <span class="n">alist_</span><span class="p">[:</span><span class="n">agrplen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">bperm_</span> <span class="o">=</span> <span class="n">blist_</span><span class="p">[:</span><span class="n">bgrplen</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">]</span>

        <span class="n">acrpts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bcrpts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">acrptscontp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bcrptscontp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">etacrpts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xicrpts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">acrptflux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bcrptflux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">afield</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">bfield</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">aused</span> <span class="o">=</span> <span class="n">amagref</span><span class="p">[</span><span class="n">aperm</span><span class="p">]</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">a_sky_inds</span><span class="p">[</span><span class="n">aperm</span><span class="p">]</span>

        <span class="n">bused</span> <span class="o">=</span> <span class="n">bmagref</span><span class="p">[</span><span class="n">bperm</span><span class="p">]</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">b_sky_inds</span><span class="p">[</span><span class="n">bperm</span><span class="p">]</span>

        <span class="n">arefinds</span> <span class="o">=</span> <span class="n">amodelrefinds</span><span class="p">[:,</span> <span class="n">aperm</span><span class="p">]</span>
        <span class="n">brefinds</span> <span class="o">=</span> <span class="n">bmodelrefinds</span><span class="p">[:,</span> <span class="n">bperm</span><span class="p">]</span>

        <span class="n">counterpartgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">etagrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">xigrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">acontamprobgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">),</span> <span class="n">n_fracs</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">bcontamprobgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">),</span> <span class="n">n_fracs</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">acontamfluxgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">bcontamfluxgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">afieldarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">bfieldarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">bina</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">)),</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">binb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)),</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">Nfa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">Nfb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">)),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)),</span> <span class="nb">float</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">)):</span>
            <span class="n">bina</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">a_photo</span><span class="p">[</span><span class="n">aperm</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">amagref</span><span class="p">[</span><span class="n">aperm</span><span class="p">[</span><span class="n">j</span><span class="p">]]]</span> <span class="o">-</span> <span class="n">abinsarray</span><span class="p">[</span>
                <span class="p">:</span><span class="n">abinlengths</span><span class="p">[</span><span class="n">aused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">qa</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">aused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">qa</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># For the field sources we don&#39;t know which other filter to use, so we</span>
            <span class="c1"># just default to using the first filter in the opposing catalogue,</span>
            <span class="c1"># but it shouldn&#39;t matter since it ought to be independent.</span>
            <span class="n">Nfa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fa_priors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">aused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">qa</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">fa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fa_array</span><span class="p">[</span><span class="n">bina</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">qa</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">acontamfluxgrid</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">aflux_grids</span><span class="p">[</span><span class="n">arefinds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">arefinds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">arefinds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)):</span>
            <span class="n">binb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">b_photo</span><span class="p">[</span><span class="n">bperm</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">bmagref</span><span class="p">[</span><span class="n">bperm</span><span class="p">[</span><span class="n">j</span><span class="p">]]]</span> <span class="o">-</span> <span class="n">bbinsarray</span><span class="p">[</span>
                <span class="p">:</span><span class="n">bbinlengths</span><span class="p">[</span><span class="n">bused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">qb</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">bused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">qb</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Nfb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_priors</span><span class="p">[</span><span class="n">bused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qb</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">fb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_array</span><span class="p">[</span><span class="n">binb</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">bused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qb</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
            <span class="n">bcontamfluxgrid</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">bflux_grids</span><span class="p">[</span><span class="n">brefinds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">brefinds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">brefinds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">]]</span>

        <span class="n">bfourgausses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)):</span>
            <span class="n">bsig</span> <span class="o">=</span> <span class="n">b_astro</span><span class="p">[</span><span class="n">bperm</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">bfourgausses</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">bsig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">afieldarray</span> <span class="o">=</span> <span class="n">Nfa</span><span class="o">*</span><span class="n">fa</span>
        <span class="n">bfieldarray</span> <span class="o">=</span> <span class="n">Nfb</span><span class="o">*</span><span class="n">fb</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">)):</span>
            <span class="n">aF</span> <span class="o">=</span> <span class="n">afrac_grids</span><span class="p">[:,</span> <span class="n">arefinds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">arefinds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">arefinds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">]]</span>
            <span class="n">aoffs</span> <span class="o">=</span> <span class="n">afourier_grids</span><span class="p">[:,</span> <span class="n">arefinds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">arefinds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">arefinds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">]]</span>
            <span class="n">asig</span> <span class="o">=</span> <span class="n">a_astro</span><span class="p">[</span><span class="n">aperm</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">afourgauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">asig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)):</span>
                <span class="c1"># sep comes out of haversine in degrees, but contam_match_prob</span>
                <span class="c1"># assumes everything is in arcseconds, so convert sep here.</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="n">mff</span><span class="o">.</span><span class="n">haversine_wrapper</span><span class="p">(</span><span class="n">a_astro</span><span class="p">[</span><span class="n">aperm</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">b_astro</span><span class="p">[</span><span class="n">bperm</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span>
                                            <span class="n">a_astro</span><span class="p">[</span><span class="n">aperm</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">b_astro</span><span class="p">[</span><span class="n">bperm</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span>
                <span class="n">bF</span> <span class="o">=</span> <span class="n">bfrac_grids</span><span class="p">[:,</span> <span class="n">brefinds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">brefinds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">brefinds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">]]</span>
                <span class="n">boffs</span> <span class="o">=</span> <span class="n">bfourier_grids</span><span class="p">[:,</span> <span class="n">brefinds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">brefinds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">brefinds</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">k</span><span class="p">]]</span>

                <span class="c1"># Calculate the probability densities of all four combinations</span>
                <span class="c1"># of perturbation and non-perturbation AUFs.</span>
                <span class="n">G0nn</span> <span class="o">=</span> <span class="n">afourgauss</span><span class="o">*</span><span class="n">bfourgausses</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">G0cc</span> <span class="o">=</span> <span class="n">aoffs</span><span class="o">*</span><span class="n">boffs</span><span class="o">*</span><span class="n">G0nn</span>
                <span class="n">G0cn</span> <span class="o">=</span> <span class="n">aoffs</span><span class="o">*</span><span class="n">G0nn</span>
                <span class="n">G0nc</span> <span class="o">=</span> <span class="n">boffs</span><span class="o">*</span><span class="n">G0nn</span>
                <span class="n">Gcc</span><span class="p">,</span> <span class="n">Gcn</span><span class="p">,</span> <span class="n">Gnc</span><span class="p">,</span> <span class="n">Gnn</span> <span class="o">=</span> <span class="n">cpf</span><span class="o">.</span><span class="n">contam_match_prob</span><span class="p">(</span>
                    <span class="n">G0cc</span><span class="p">,</span> <span class="n">G0cn</span><span class="p">,</span> <span class="n">G0nc</span><span class="p">,</span> <span class="n">G0nn</span><span class="p">,</span> <span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">drho</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
                <span class="c1"># G would be in units of per square arcseconds, but we need it</span>
                <span class="c1"># in units of per square degree to compare to Nf.</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">Gcc</span> <span class="o">*</span> <span class="mi">3600</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">):</span>
                    <span class="n">pr</span> <span class="o">=</span> <span class="p">(</span><span class="n">aF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="n">bF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="n">Gcc</span> <span class="o">+</span> <span class="n">aF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">bF</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">*</span><span class="n">Gcn</span> <span class="o">+</span>
                          <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">aF</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">*</span><span class="n">bF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="n">Gnc</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">aF</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">bF</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">*</span><span class="n">Gnn</span><span class="p">)</span>
                    <span class="c1"># Marginalise over the opposite source contamination probability</span>
                    <span class="c1"># to calculate specific source&#39;s contamination chance.</span>
                    <span class="n">acontamprobgrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">aF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="n">bF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="n">Gcc</span> <span class="o">+</span>
                                                               <span class="n">aF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">bF</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">*</span><span class="n">Gcn</span><span class="p">)</span><span class="o">/</span><span class="n">pr</span><span class="p">))</span>
                    <span class="n">bcontamprobgrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ff</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">aF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="n">bF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="n">Gcc</span> <span class="o">+</span>
                                                               <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">aF</span><span class="p">[</span><span class="n">ff</span><span class="p">])</span><span class="o">*</span><span class="n">bF</span><span class="p">[</span><span class="n">ff</span><span class="p">]</span><span class="o">*</span><span class="n">Gnc</span><span class="p">)</span><span class="o">/</span><span class="n">pr</span><span class="p">))</span>

                <span class="n">Nc</span> <span class="o">=</span> <span class="n">c_priors</span><span class="p">[</span><span class="n">bused</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">aused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">qb</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                <span class="n">cdmdm</span> <span class="o">=</span> <span class="n">c_array</span><span class="p">[</span><span class="n">binb</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">bina</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">bused</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">aused</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">qb</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                <span class="n">counterpartgrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">*</span><span class="n">G</span><span class="o">*</span><span class="n">cdmdm</span>

                <span class="k">if</span> <span class="n">fa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">fb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">etagrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="k">elif</span> <span class="n">cdmdm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">etagrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">etagrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cdmdm</span><span class="o">/</span><span class="p">(</span><span class="n">fa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">fb</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">Nfa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">Nfb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">xigrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="k">elif</span> <span class="n">Nc</span><span class="o">*</span><span class="n">G</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">xigrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xigrid</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Nc</span><span class="o">*</span><span class="n">G</span><span class="o">/</span><span class="p">(</span><span class="n">Nfa</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">Nfb</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Start with the case of no matches between any island objects.</span>
        <span class="n">tempprob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">afieldarray</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">bfieldarray</span><span class="p">)</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">+</span> <span class="n">tempprob</span>
        <span class="k">if</span> <span class="n">tempprob</span> <span class="o">&gt;</span> <span class="n">prob</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">tempprob</span>
            <span class="n">acrpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">bcrpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="c1"># With unknown blank array have to reshape the two two-dimensional</span>
            <span class="c1"># arrays to (0, n_fracs).</span>
            <span class="n">acrptscontp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">)</span>
            <span class="n">bcrptscontp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fracs</span><span class="p">)</span>
            <span class="n">etacrpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">xicrpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">acrptflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">bcrptflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">afield</span> <span class="o">=</span> <span class="n">aperm_</span>
            <span class="n">bfield</span> <span class="o">=</span> <span class="n">bperm_</span>
        <span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">aiter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">aperm</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">N</span><span class="p">)))</span>
            <span class="n">biter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">bperm</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">N</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aiter</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">biter</span><span class="p">:</span>
                    <span class="c1"># For paired sources, order matters, so we have to find the</span>
                    <span class="c1"># index of the array holding the source&#39;s overall catalogue</span>
                    <span class="c1"># index that matches that index in the permutation list.</span>
                    <span class="n">ya</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">aperm</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">x</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
                    <span class="n">yb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">bperm</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">y</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>
                    <span class="n">ta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aperm</span><span class="p">)),</span> <span class="n">ya</span><span class="p">)</span>
                    <span class="n">tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bperm</span><span class="p">)),</span> <span class="n">yb</span><span class="p">)</span>
                    <span class="n">tempprob</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">counterpartgrid</span><span class="p">[</span><span class="n">ya</span><span class="p">,</span> <span class="n">yb</span><span class="p">])</span> <span class="o">*</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">afieldarray</span><span class="p">[</span><span class="n">ta</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">bfieldarray</span><span class="p">[</span><span class="n">tb</span><span class="p">]))</span>
                    <span class="n">integral</span> <span class="o">=</span> <span class="n">integral</span> <span class="o">+</span> <span class="n">tempprob</span>
                    <span class="k">if</span> <span class="n">tempprob</span> <span class="o">&gt;</span> <span class="n">prob</span><span class="p">:</span>
                        <span class="n">prob</span> <span class="o">=</span> <span class="n">tempprob</span>
                        <span class="n">acrpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aperm_</span><span class="p">[</span><span class="n">ya</span><span class="p">])</span>
                        <span class="n">bcrpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bperm_</span><span class="p">[</span><span class="n">yb</span><span class="p">])</span>
                        <span class="n">acrptscontp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">acontamprobgrid</span><span class="p">[</span><span class="n">ya</span><span class="p">,</span> <span class="n">yb</span><span class="p">])</span>
                        <span class="n">bcrptscontp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bcontamprobgrid</span><span class="p">[</span><span class="n">ya</span><span class="p">,</span> <span class="n">yb</span><span class="p">])</span>
                        <span class="n">etacrpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">etagrid</span><span class="p">[</span><span class="n">ya</span><span class="p">,</span> <span class="n">yb</span><span class="p">])</span>
                        <span class="n">xicrpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xigrid</span><span class="p">[</span><span class="n">ya</span><span class="p">,</span> <span class="n">yb</span><span class="p">])</span>
                        <span class="n">acrptflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">acontamfluxgrid</span><span class="p">[</span><span class="n">ya</span><span class="p">])</span>
                        <span class="n">bcrptflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bcontamfluxgrid</span><span class="p">[</span><span class="n">yb</span><span class="p">])</span>
                        <span class="n">afield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">aperm_</span><span class="p">[</span><span class="n">ta</span><span class="p">])</span>
                        <span class="n">bfield</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bperm_</span><span class="p">[</span><span class="n">tb</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">acrpts</span><span class="p">,</span> <span class="n">bcrpts</span><span class="p">,</span> <span class="n">acrptscontp</span><span class="p">,</span> <span class="n">bcrptscontp</span><span class="p">,</span> <span class="n">etacrpts</span><span class="p">,</span> <span class="n">xicrpts</span><span class="p">,</span> <span class="n">acrptflux</span><span class="p">,</span> <span class="n">bcrptflux</span><span class="p">,</span>
                <span class="n">afield</span><span class="p">,</span> <span class="n">bfield</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">integral</span><span class="p">]</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">macauff</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">macauff.counterpart_pairing</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Tom J Wilson.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.4.
    </div>
  </body>
</html>